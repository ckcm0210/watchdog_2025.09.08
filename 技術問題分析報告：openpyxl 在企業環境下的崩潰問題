<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

## æŠ€è¡“å•é¡Œåˆ†æå ±å‘Šï¼šopenpyxl åœ¨ä¼æ¥­ç’°å¢ƒä¸‹çš„å´©æ½°å•é¡Œ

### å•é¡Œæ¦‚è¿°

**å•é¡Œæè¿°**ï¼šPython ç¨‹å¼åœ¨ä¼æ¥­ Windows ç’°å¢ƒä¸‹ä½¿ç”¨ watchdog ç›£æ§ Excel æª”æ¡ˆæ™‚ï¼Œå‡ºç¾ `Windows fatal exception: code 0x80000003` éŒ¯èª¤ï¼Œå°è‡´ç¨‹å¼ç«‹å³å´©æ½°ã€‚

**ç’°å¢ƒè³‡è¨Š**ï¼š

- Python ç‰ˆæœ¬ï¼š3.11/3.12
- openpyxl ç‰ˆæœ¬ï¼š3.0.10 - 3.1.5
- ä½œæ¥­ç³»çµ±ï¼šWindows Enterprise
- è§¸ç™¼æ¢ä»¶ï¼šé‡å•Ÿé›»è…¦å¾Œæ¯æ¬¡åŸ·è¡Œå¿…å®šå´©æ½°


### å•é¡Œæ ¹å› åˆ†æ

#### 1. çœŸæ­£çš„æ ¹æœ¬åŸå› 

ç¶“éè©³ç´°åˆ†æç™¼ç¾ï¼Œå•é¡Œä¸¦éå¤šç·šç¨‹ç«¶æ…‹æ¢ä»¶ï¼Œè€Œæ˜¯ **Python ç‰ˆæœ¬é–“åƒåœ¾å›æ”¶æ©Ÿåˆ¶çš„é‡å¤§è®ŠåŒ–**ï¼š

**Python 3.8**ï¼š

- ä¿å®ˆçš„åƒåœ¾å›æ”¶ç­–ç•¥
- è¼ƒå¯¬é¬†çš„ reference counting æª¢æŸ¥
- å° C æ“´å±•è¨˜æ†¶é«”éŒ¯èª¤è¼ƒç‚ºå®¹å¿

**Python 3.11/3.12**ï¼š

- æ›´ç©æ¥µçš„åƒåœ¾å›æ”¶æ©Ÿåˆ¶
- åš´æ ¼çš„è¨˜æ†¶é«”é‚Šç•Œæª¢æŸ¥
- å° C æ“´å±•çš„ reference counting éŒ¯èª¤é›¶å®¹å¿


#### 2. ä¼æ¥­ç’°å¢ƒçš„ç‰¹æ®Šæ€§

**Windows Home vs Enterprise çš„å·®ç•°**ï¼š

- Home ç‰ˆæœ¬ï¼šå°è¨˜æ†¶é«” corruption è¼ƒç‚ºå¯¬å®¹
- Enterprise ç‰ˆæœ¬ï¼šåš´æ ¼çš„è¨˜æ†¶é«”ä¿è­·ï¼Œç«‹å³çµ‚æ­¢æœ‰å•é¡Œçš„é€²ç¨‹


#### 3. openpyxl çš„è¨˜æ†¶é«”ç®¡ç†ç¼ºé™·

openpyxl å…§éƒ¨å­˜åœ¨ reference counting bugï¼Œåœ¨ Python 3.11+ çš„åš´æ ¼åƒåœ¾å›æ”¶æª¢æŸ¥ä¸‹æš´éœ²ï¼š

```
Current thread 0x000021fc (most recent call first):
Garbage-collecting
```


### è§£æ±ºæ–¹æ¡ˆå°æ¯”

#### æ¸¬è©¦éçš„æ–¹æ¡ˆåŠçµæœ

| æ–¹æ¡ˆ | çµæœ | åŸå›  |
| :-- | :-- | :-- |
| é™ç´šåˆ° Python 3.11 | âŒ å¤±æ•— | å•é¡Œåœ¨ 3.11+ éƒ½å­˜åœ¨ |
| ç¦ç”¨ C æ“´å±• (`sys.modules['_elementtree'] = None`) | âŒ å¤±æ•— | å•é¡Œä¸åªåœ¨ C æ“´å±• |
| ä½¿ç”¨ PollingObserver | âŒ å¤±æ•— | å•é¡Œä¸åœ¨ Observer é¡å‹ |
| å•Ÿç”¨ lxml å¾Œç«¯ | âŒ å¤±æ•— | å•é¡Œåœ¨ openpyxl æœ¬èº« |
| **èª¿æ•´åƒåœ¾å›æ”¶é–¾å€¼** | âœ… **æˆåŠŸ** | é¿é–‹è§¸ç™¼é »ç‡å•é¡Œ |

#### æœ‰æ•ˆçš„è§£æ±ºæ–¹æ¡ˆ

**æ–¹æ¡ˆï¼šèª¿æ•´åƒåœ¾å›æ”¶é–¾å€¼**

```python
import gc
gc.set_threshold(10000, 100, 100)  # æ¥µåº¦ä¿å®ˆçš„é–¾å€¼
```

**åŸç†**ï¼š

- å¤§å¹…æ¸›å°‘å¾ªç’°åƒåœ¾å›æ”¶çš„è§¸ç™¼é »ç‡
- çµ¦ openpyxl å……è¶³æ™‚é–“å®Œæˆå…§éƒ¨æ¸…ç†
- é¿é–‹ Python 3.11+ ç©æ¥µ GC èˆ‡ openpyxl çš„è¡çªæ™‚æ©Ÿ


### Import é †åºçš„é—œéµå·®ç•°

#### âŒ éŒ¯èª¤åšæ³•ï¼š

```python
from openpyxl import load_workbook  # openpyxl æŒ‰ç•¶å‰ GC è¨­å®šåˆå§‹åŒ–
import gc
gc.set_threshold(10000, 100, 100)  # å¤ªæ™šäº†ï¼Œæ²’æœ‰æ•ˆæœ
```


#### âœ… æ­£ç¢ºåšæ³•ï¼š

```python
import gc
gc.set_threshold(10000, 100, 100)  # åœ¨ä»»ä½•æ¨¡çµ„åˆå§‹åŒ–å‰è¨­å®š
from openpyxl import load_workbook  # openpyxl æŒ‰æ–° GC è¨­å®šåˆå§‹åŒ–
```

**é—œéµåŸå› **ï¼š

- openpyxl åœ¨é¦–æ¬¡ import æ™‚æœƒæ ¹æ“š**ç•¶æ™‚çš„ GC è¨­å®š**åˆå§‹åŒ–å…§éƒ¨çµ„ä»¶
- GC é–¾å€¼å½±éŸ¿ openpyxl å…§éƒ¨ç‰©ä»¶çš„ç”Ÿå‘½é€±æœŸç®¡ç†ç­–ç•¥
- ä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå¾ŒçºŒä¿®æ”¹ GC è¨­å®šå°å·²è¼‰å…¥çš„æ¨¡çµ„ç„¡æ•ˆ


### å®Œæ•´è§£æ±ºæ–¹æ¡ˆå¯¦æ–½

```python
# main.py - å®Œæ•´çš„è§£æ±ºæ–¹æ¡ˆ

# ========== ç¬¬ä¸€æ­¥ï¼šç’°å¢ƒè®Šæ•¸è¨­å®š ==========
import os
os.environ["OPENPYXL_LXML"] = "True"

# ========== ç¬¬äºŒæ­¥ï¼šåƒåœ¾å›æ”¶è¨­å®šï¼ˆé—œéµï¼‰==========
import gc
gc.set_threshold(10000, 100, 100)
print(f"âœ… GC é–¾å€¼è¨­å®šå®Œæˆ: {gc.get_threshold()}")

# ========== ç¬¬ä¸‰æ­¥ï¼šæ­£å¸¸ imports ==========
import time
from pathlib import Path
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class SafeExcelHandler(FileSystemEventHandler):
    def on_modified(self, event):
        if event.is_directory or not event.src_path.endswith('.xlsx'):
            return
        
        # å»¶é² importï¼Œç¢ºä¿åœ¨æ­£ç¢ºçš„ GC è¨­å®šä¸‹è¼‰å…¥
        from openpyxl import load_workbook
        
        try:
            wb = load_workbook(event.src_path, read_only=True, data_only=True)
            # è™•ç†é‚è¼¯
            wb.close()
            print(f"âœ… æˆåŠŸè™•ç†: {Path(event.src_path).name}")
        except Exception as e:
            print(f"âŒ è™•ç†å¤±æ•—: {e}")

def main():
    observer = Observer()
    handler = SafeExcelHandler()
    observer.schedule(handler, "ç›£æ§ç›®éŒ„", recursive=True)
    
    print("ğŸš€ Excel ç›£æ§å·²å•Ÿå‹•...")
    observer.start()
    
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()
    
    observer.join()

if __name__ == "__main__":
    main()
```


### å‚™ç”¨è§£æ±ºæ–¹æ¡ˆ

å¦‚æœèª¿æ•´ GC é–¾å€¼ä»ç„¶ç„¡æ•ˆï¼Œå¯ä½¿ç”¨**é€²ç¨‹éš”é›¢æ–¹æ¡ˆ**ï¼š

```python
import subprocess
import sys
import json
import threading

def process_excel_isolated(file_path):
    script = f'''
import os
import gc
os.environ["OPENPYXL_LXML"] = "True"
gc.set_threshold(10000, 100, 100)

from openpyxl import load_workbook
import json

try:
    wb = load_workbook(r"{file_path}", read_only=True)
    result = {{"status": "success", "sheets": list(wb.sheetnames)}}
    wb.close()
    print(json.dumps(result))
except Exception as e:
    print(json.dumps({{"status": "error", "error": str(e)}}))
'''
    
    result = subprocess.run(
        [sys.executable, '-c', script],
        capture_output=True, text=True, timeout=30
    )
    
    return json.loads(result.stdout) if result.returncode == 0 else {"status": "error"}
```


### é—œéµå­¸ç¿’

1. **ç’°å¢ƒå·®ç•°çš„é‡è¦æ€§**ï¼šåŒä¸€ç¨‹å¼åœ¨ä¸åŒç’°å¢ƒï¼ˆHome vs Enterpriseï¼‰è¡¨ç¾å®Œå…¨ä¸åŒ
2. **Python ç‰ˆæœ¬å‡ç´šé¢¨éšª**ï¼šç‰ˆæœ¬å‡ç´šå¯èƒ½å¼•å…¥æ–°çš„å…¼å®¹æ€§å•é¡Œ
3. **Import é †åºçš„é—œéµæ€§**ï¼šæ¨¡çµ„åˆå§‹åŒ–é †åºç›´æ¥å½±éŸ¿é‹è¡Œæ™‚è¡Œç‚º
4. **åƒåœ¾å›æ”¶èª¿å„ª**ï¼šé©ç•¶çš„ GC è¨­å®šå¯ä»¥è§£æ±ºæ£˜æ‰‹çš„å…¼å®¹æ€§å•é¡Œ

### å»ºè­°èˆ‡æœ€ä½³å¯¦è¸

1. **ç”Ÿç”¢ç’°å¢ƒæ¸¬è©¦**ï¼šé‡å¤§ç‰ˆæœ¬å‡ç´šå‰å‹™å¿…åœ¨ç›®æ¨™ç’°å¢ƒå……åˆ†æ¸¬è©¦
2. **ç’°å¢ƒéš”é›¢**ï¼šé—œéµæ‡‰ç”¨è€ƒæ…®ä½¿ç”¨ Docker ç­‰å®¹å™¨æŠ€è¡“çµ±ä¸€ç’°å¢ƒ
3. **éŒ¯èª¤éš”é›¢**ï¼šå°æ–¼ä¸ç©©å®šçš„ç¬¬ä¸‰æ–¹åº«ï¼Œè€ƒæ…®é€²ç¨‹éš”é›¢æ–¹æ¡ˆ
4. **ç›£æ§å‘Šè­¦**ï¼šè¨­ç½®é©ç•¶çš„éŒ¯èª¤ç›£æ§å’Œè‡ªå‹•é‡å•Ÿæ©Ÿåˆ¶

é€™å€‹è§£æ±ºæ–¹æ¡ˆé€šéèª¿æ•´ Python åƒåœ¾å›æ”¶é–¾å€¼ï¼ŒæˆåŠŸè§£æ±ºäº† openpyxl åœ¨ä¼æ¥­ Windows ç’°å¢ƒä¸‹çš„å´©æ½°å•é¡Œï¼Œç‚ºé¡ä¼¼çš„ç¬¬ä¸‰æ–¹åº«å…¼å®¹æ€§å•é¡Œæä¾›äº†æœ‰æ•ˆçš„è§£æ±ºæ€è·¯ã€‚
<span style="display:none">[^1]</span>

<div style="text-align: center">â‚</div>

[^1]: image.jpg

